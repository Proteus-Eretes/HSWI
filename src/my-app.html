<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="styles/shared-styles.html">
<link rel="import" href="styles/shared-styles-button.html">
<link rel="import" href="views/match.html">
<link rel="import" href="views/matchList.html">
<link rel="import" href="views/lastResult.html">
<link rel="import" href="views/years.html">
<link rel="import" href="teams/teamlist.html">
<link rel="import" href="elements/search.html">

<dom-module id="my-app">
    <template>


        <style include="shared-styles shared-styles-button">
            :host {
                --app-primary-color: #000;
                --app-secondary-color: #FFF;
                --app-drawer-width: 320px;
                display: block;
            }

            app-header {
                color: #FFF;
                background-color: var(--app-primary-color);
            }

            .header-bar {
                height: 44px;
                display: flex;
            }

            .img-header-bar {
                height: calc(44px - 8px);
                padding: 8px 4px 4px;
                float: left;
            }

            .hamburger {
                padding  : 6px 8px 10px;
                font-size: 20px;
            }

            .menu-header {
                background-color: #ECECEC;
            }

            app-header paper-icon-button {
                --paper-icon-button-ink-color: white;
            }

            .menu {
                z-index: 1;
            }

        </style>

        <app-location route="{{route}}"></app-location>

        <app-route route="{{route}}" pattern="/iframe" data="{{routeData}}" tail="{{subRouteMatch}}"></app-route>

        <app-drawer-layout responsive-width="1280px" fullbleed>
            <!-- Drawer content -->
            <app-drawer slot="drawer" style$="[[_hide(iframe)]]" class="menu" swipe-open id="drawer">
                <div style="height: 100%; overflow: auto;">
                    <app-toolbar class="menu-header">Wedstrijden</app-toolbar>
                    <match-list route="{{route}}"></match-list>
                </div>
            </app-drawer>

            <!-- Main content -->
            <app-header-layout has-scrolling-region>

                <!-- header, shell -->
                <app-header class="header-bar" slot="header" reveals effects="waterfall">
                    <app-toolbar class="header-bar" id="top">
                        <button class="headerButton hamburger" style$="[[_hide(iframe)]]" id="menu" drawer-toggle>&#9776;</button>
                        <img
                                class="img-header-bar"
                                src="https://beta.hoesnelwasik.nl/images/manifest/icon-192x192.png"
                                on-click="goHome"/>

                        <i-year-list match="[[match]]" path="{{routeMatch}}"></i-year-list>
                        <!--Filler-->
                        <div main-title></div>
                        <button class="headerButton">Uitslagen</button>
                        <button class="headerButton">Live</button>
                    </app-toolbar>
                </app-header>
                <search-match route="{{routeMatch}}"></search-match>
                <template is="dom-if" if="[[matchPage]]">
                    <main-match id="match" route="{{routeMatch}}" iframe="[[iframe]]"></main-match>
                </template>
                <template is="dom-if" if="[[resultPage]]">
                    <team-list path="{{routeMatch}}"></team-list>
                </template>
                <footer style="color: #FFF">
                    Copyright
                    <a style="color: #ECECEC" href="https://www.poweredbyiris.nl">PoweredByIRIS</a>
                </footer>
            </app-header-layout>
        </app-drawer-layout>

    </template>

    <script>
        // Extend Polymer.Element base class
        class MyApp extends Polymer.Element {

            static get is() {
                return 'my-app';
            }

            connectedCallback() {
                this.match = '';
                super.connectedCallback();
                // this.shadowRoot.querySelector('#menu').addEventListener('click', function() {
                // self.shadowRoot.querySelector('#drawer').toggle(); });
            }

            /**
             * Are we in Iframe mode hide the menu
             */
            _hide(iframe) {
                if (!iframe)
                    return '';
                return 'display:none';
            }

            /**
             * If a route has happend the routeMatch strip iframe
             * Send google pageview
             */
            _updateRoute(newValue, oldValue) {
                if (this.subRouteMatch && this.subRouteMatch.prefix === '/iframe') {
                    this.iframe = true;
                    this.routeMatch = this.subRouteMatch.path;
                } else {
                    this.routeMatch = this.route.path;
                    this.iframe = false;
                }
                ga('send', 'pageview', this.route.path);
                this._location();
            }

            _year(route) {
                return route.split('/')[2];
            }

            /**
             * Return field name
             */
            _field(route) {
                return route.split('/')[3];
            }

            /**
             * Go to the mainpage
             */
            goHome(e) {
                if (this.iframe) {
                    if (this.routeMatch.split('/').length > 2) {
                        this.set('routeMatch', '/' + this.routeMatch.split('/')[1] + '/' + this.routeMatch.split('/')[2]);
                    } else {
                        this.set('routeMatch', '/' + this.routeMatch.split('/')[1]);
                    }
                } else {
                    this.set('routeMatch', '/');
                }
            }

            /**
             * return to the match
             */
            goToMatch(e) {
                this.set('routeMatch', '/' + this.routeMatch.split('/')[1] + '/' + this.routeMatch.split('/')[2]);
            }

            /**
             * IE router
             */
            ieWindowloc(link) {
                if (this.iframe) {
                    window.location.href = 'iframe/' + link;
                } else {
                    window.location.href = link;
                }
            }

            /**
             * If a route has happend update the route object make sure iframe mode is honnuerd
             */
            _updateRouteMatch(newValue, oldValue) {
                if (this.subRouteMatch && this.subRouteMatch.prefix === '/iframe') {
                    this.set('route.path', '/iframe' + this.routeMatch);
                } else {
                    this.set('route.path', this.routeMatch);
                }
                this._location();
            }

            /**
             * Close app drawer when route change has happend
             */
            _routePageChanged(page) {
                if (!this.iframe && this.shadowRoot.querySelector('#drawer') && !this.shadowRoot.querySelector('#drawer').persistent) {
                    this.shadowRoot.querySelector('#drawer').close();
                }
            }

            /**
             * Go to the top of the page
             */
            toTop() {
                this.shadowRoot.querySelector('#top').scrollIntoView();
            }

            /**
             * Rerturn the match name
             */
            getMatchShortName() {
                return this.match.split(' ')[0];
            }

            /**
             * Rerturn the match name
             */
            getMatchShort() {
                return this.match;
            }

            setMatch(match) {
                this.match = match;
            }

            //TODO make this into arrow functions for flexiblity
            /**
             * Which page should be open
             */
            _location() {
                this.matchPage = false;
                this.resultPage = false;
                switch (this.routeMatch.split('/').length) {
                    case 0:
                    case 1:
                    case 2:
                    case 3:
                    case 4:
                        this.matchPage = true;
                        break;
                    default:
                        this.resultPage = true;
                        break;
                }
            }

            static get observers() {
                return ['_routePageChanged(route)'];
            }

            static get properties() {
                return {
                    iframe: {
                        type: Boolean,
                        value: true
                    },
                    route: {
                        type: Object,
                        notify: true,
                        readOnly: false,
                        observer: '_updateRoute'
                    },
                    routeMatch: {
                        type: String,
                        notify: true,
                        readOnly: false,
                        observer: '_updateRouteMatch'
                    },
                    matchPage: {
                        type: Boolean,
                        notify: true,
                        readOnly: false,
                        value: false
                    },
                    resultPage: {
                        type: Boolean,
                        notify: true,
                        readOnly: false,
                        value: false
                    },
                    match: {
                        type: Array,
                        notify: true,
                        readOnly: false
                    },
                    dropDownVar: {
                        type: Boolean,
                        value: false,
                        notify: true,
                        readOnly: false
                    }
                };
            }
        }

        // Register custom element definition using standard platform API
        customElements.define(MyApp.is, MyApp);
    </script>
</dom-module>
