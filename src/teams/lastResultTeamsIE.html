<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../clubs/oars.html">
<link rel="import" href="../app/time.html">
<link rel="import" href="../app/team.html">
<link rel="import" href="../styles/shared-styles-tables.html">
<link rel="import" href="../styles/shared-styles.html">

<dom-module id="last-result-table">
  <template>
    <style include="shared-styles-tables shared-styles">
      .table {
        display: table;
      }
      .divRow
      {
         display:table-row;
         width:100%;
      }

      .divCell
      {
          display:table-column;
          width:auto;
      }

      .divCellHeader
      {
          display:table-column;
          width:auto;
      }
    </style>
    <template is="dom-if" if="[[!noTeams]]">
      <div class="table">
        <div class="divRow">
          <div class="divCellHeader" ></div>
          <div class="divCellHeader"  style="max-width: 50px">
              Pos
          </div>
          <div class="divCellHeader"  class="show-gt-md">
              Veld
          </div>
          <div class="divCellHeader" >
              Rug#
          </div>
          <div class="divCellHeader" >
              Ploeg
          </div>
          <div class="divCellHeader"  class="show-gt-md">
              Slag
          </div>
          <template is="dom-if" if=[[displaySplash1]]>
            <div class="divCellHeader"  class$=[[_setClasses(1)]]>
                Tussentijd 1
            </div>
          </template>
          <template is="dom-if" if=[[displaySplash2]]>
            <div class="divCellHeader"  class$=[[_setClasses(2)]]>
                Tussentijd 2
            </div>
          </template>
          <template is="dom-if" if=[[displaySplash3]]>
            <div class="divCellHeader"  class$=[[_setClasses(3)]]>
                Tussentijd 3
            </div>
          </template>
          <template is="dom-if" if=[[displaySplash4]]>
            <div class="divCellHeader"  class$=[[_setClasses(4)]]>
                Tussentijd 4
            </div>
          </template>
          <template is="dom-if" if=[[_displaySplash(5)]]>
            <div class="divCellHeader"  class$=[[_setClasses(5)]]>
                Finishtijd
            </div>
          </template>
        </tr>
        <tbody>
          <template is="dom-repeat" items="[[teams]]" as="team">
            <div class="divRow" on-click="_openTeam" style="cursor: pointer;">
              <div class="divCell" >
                <oars-img club="[[team.clubnameshort]]"></oars-img>
              </div>
              <div class="divCell" >
                  [[team.rank]] / [[team.participants]]
              </div>
              <div class="divCell"  class="show-gt-md">
                <template is="dom-if" if="[[!_hasValue(team.fieldnameshortsub)]]">
                  [[team.fieldnameshortsub]]
                </template>
                <template is="dom-if" if="[[_hasValue(team.fieldnameshortsub)]]">
                  [[team.fieldnameshort]]
                </template>
              </div>
              <div class="divCell" >
                  [[team.backnumber]]
              </div>
              <div class="divCell"  class="teamname">
                  [[team.teamname]]
              </div>
              <div class="divCell"  class="show-gt-md">
                  [[team.rower8]]
              </div>
              <template is="dom-if" if=[[displaySplash1]]>
                <div class="divCell"  class$=[[_setClasses(1)]]>
                    [[_displayTime(team.splash1,0)]]
                </div>
              </template>
              <template is="dom-if" if=[[displaySplash2]]>
                <div class="divCell"  class$=[[_setClasses(2)]]>
                    [[_displayTime(team.splash2,0)]]
                </div>
              </template>
              <template is="dom-if" if=[[displaySplash3]]>
                <div class="divCell"  class$=[[_setClasses(3)]]>
                    [[_displayTime(team.splash3,0)]]
                </div>
              </template>
              <template is="dom-if" if=[[displaySplash4]]>
                <div class="divCell"  class$=[[_setClasses(4)]]>
                    [[_displayTime(team.splash4,0)]]
                </div>
              </template>
              <template is="dom-if" if=[[_displaySplash(5)]]>
                <div class="divCell"  class$=[[_setClasses(5)]]>
                    <final-time team="[[team]]"></final-time>
                </div>
              </template>
            </tr>
          </template>
        </tbody>
      </div>
    </template>
    <template is="dom-if" if="[[noTeams]]">
      <div class="noTeams">
        Er zijn helaas nog geen ploegen voorbij dit punt.
      </div>
    </template>
  </template>

  <script>
    // Extend Polymer.Element base class
    class LastResultTable extends Polymer.Element {

      static get is() { return 'last-result-table'; }

      connectedCallback() {
        super.connectedCallback();
      }

      /**
       * TODO clean this
       * Which splashes should be shown had troubles with dom-if
       */
      _teamsChanged(newValue, oldValue) {
        if (this.noTeams === false) {
          this.splashCount = checkSplash(this.teams);
          this.displaySplash1=this._displaySplash(1);
          this.displaySplash2=this._displaySplash(2);
          this.displaySplash3=this._displaySplash(3);
          this.displaySplash4=this._displaySplash(4);
          }
      }

      /**
       * formatTime
       */
      _displayTime(time,bonussecond) {
        return formatTime(finalTime(time,bonussecond));
      }

      /**
       * Set the classes based on the view
       */
      _setClasses(splash) {
        if (this.splash === undefined)
          this.splash = this._getSplash();
        return (splash == this.splash) ? '' : 'show-gt-md';
      }

      /**
       * Do we have a subfield
       */
      _hasValue(field) {
        return field == 0;
      }

      /**
       * Display splashes
       */
      _displaySplash(splash) {
        if (this.splash === undefined)
          this.splash = this._getSplash();
        if (this.splashCount === undefined)
          return this.splash >= splash;
        return (this.splash >= splash && splash < this.splashCount) || (this.splash >= splash && splash === 5);
      }

      /**
       * Get the current splash had race condition in polymer-1
       * TODO check in polymer-2
       */
      _getSplash() {
        return this.getAttribute('data-splash');
      }

      /**
       * Open a team
       */
      _openTeam(e) {
        document.querySelector("team-modal").toggle(e.model.team);
      }

      static get properties() {
        return {
          teams : {
            type: Array,
            notify:true,
            readOnly:false,
            observer: '_teamsChanged',
          },
          splash: {
            type: Number,
            notify: true,
            readOnly: false,
          },
          splashCount: {
            type: Number,
            notify: true,
            readOnly: false,
          },
          noTeams: {
            type: Boolean,
            notify: true,
            readOnly:false,
            value: true,
          }
        };
      }
    }

    // Register custom element definition using standard platform API
    customElements.define(LastResultTable.is, LastResultTable);
  </script>
</dom-module>
